<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="#{pharmacies.title}">ì£¼ë³€ ì•½êµ­ ì°¾ê¸°</title>
  <!-- head íƒœê·¸ ì•ˆì— ì¶”ê°€ -->
  <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet">
  <link th:href="@{/css/pharmacies.css}" rel="stylesheet">
</head>
<body>
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-8">
      <div class="search-container">
        <h1 class="mb-4" th:text="#{pharmacies.header}">ì£¼ë³€ ì•½êµ­ ì°¾ê¸°</h1>
        <button class="btn btn-primary" onclick="searchPharmacies()">
          <i class="bi bi-search"></i>
          <span th:text="#{pharmacies.button}">ì£¼ë³€ ì•½êµ­ ê²€ìƒ‰</span>
        </button>
      </div>
      <div id="pharmacyList" class="pharmacy-list"></div>
    </div>
    <div id="pharmacyDetail" class="pharmacy-detail">
      <span class="close-btn" onclick="closeDetail()">&times;</span>
      <div class="detail-section">
        <h2 id="detailName" class="mb-4"></h2>
        <p><strong th:text="#{pharmacies.address}">ì£¼ì†Œ:</strong> <span id="detailAddress"></span></p>
        <p><strong th:text="#{pharmacies.phone}">ì „í™”ë²ˆí˜¸:</strong> <span id="detailPhone"></span></p>
      </div>
      <div class="detail-section">
        <p><strong th:text="#{pharmacies.openStatus}">ì˜ì—… ìƒíƒœ:</strong> <span id="detailOpen"></span></p>
        <p><strong th:text="#{pharmacies.hours}">ì˜ì—… ì‹œê°„:</strong> <span id="detailHours"></span></p>
      </div>
      <div class="detail-section">
        <h4 class="mb-3" th:text="#{pharmacies.mapTitle}">ì•½êµ­ ìœ„ì¹˜</h4>
        <img id="staticMap" class="static-map" onclick="openGoogleMaps()" alt="ì•½êµ­ ìœ„ì¹˜" style="cursor:pointer;">
        <p class="text-muted mt-2" th:text="#{pharmacies.mapNotice}">ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ Google Mapsì—ì„œ ìì„¸í•œ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <!-- êµ¬ê¸€ ì§€ë„ ì—´ê¸° ë²„íŠ¼ ì¶”ê°€ -->
        <button type="button" class="btn btn-outline-primary" onclick="openGoogleMaps()">
          <span th:text="#{pharmacies.mapButton}">êµ¬ê¸€ ì§€ë„ì—ì„œ ë³´ê¸°</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
<script th:inline="javascript">
  const apiKey = /*[[${googleMapsApiKey}]]*/ '';

  function searchPharmacies() {
      if (!navigator.geolocation) {
          alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
      }

      navigator.geolocation.getCurrentPosition(
          (position) => {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;
              console.log('ìœ„ì¹˜ ì¢Œí‘œ:', latitude, longitude);

              // Ajax ìš”ì²­
              fetch(`/api/map/getPharmacy?latitude=${latitude}&longitude=${longitude}`)
                  .then(response => {
                  if (!response.ok) {
                      throw new Error('ì•½êµ­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
                  return response.json();
              })
                  .then(data => {
                  displayPharmacies(data);
              })
                  .catch(error => {
                  alert(error.message);
              });
          },
          (error) => {
              alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          },
          {
              enableHighAccuracy: true, // ğŸ”´ ì´ ì˜µì…˜ì´ í•µì‹¬
              timeout: 10000,           // 10ì´ˆ ì•ˆì— ì‘ë‹µ ì—†ìœ¼ë©´ ì—ëŸ¬
              maximumAge: 0             // ìºì‹œëœ ìœ„ì¹˜ í—ˆìš© ì•ˆ í•¨
          }
      );
  }

  function displayPharmacies(data) {
    console.log(data)
    const pharmacyList = document.getElementById('pharmacyList');
    pharmacyList.innerHTML = '';

    if (!data.places || data.places.length === 0) {
      pharmacyList.innerHTML = '<p>ì£¼ë³€ ì•½êµ­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    data.places.forEach(place => {
      const name = place.displayName?.text || /*[[#{pharmacies.noDisplayName}]]*/ 'ì´ë¦„ ì—†ìŒ';
      const address = place.formattedAddress || /*[[#{pharmacies.noAddress}]]*/ 'ì£¼ì†Œ ì—†ìŒ';
      const phone = place.internationalPhoneNumber || /*[[#{pharmacies.noPhone}]]*/ 'ì „í™”ë²ˆí˜¸ ì—†ìŒ';
      const msgOpen = /*[[#{pharmacies.openNow}]]*/ 'ì˜ì—…ì¤‘';
      const msgClosed = /*[[#{pharmacies.closed}]]*/ 'ì˜ì—… ì¢…ë£Œ';
      const openNow = place.currentOpeningHours?.openNow ? msgOpen : msgClosed;
      const hours = place.currentOpeningHours?.weekdayDescriptions?.join(', ') || /*[[#{pharmacies.noHours}]]*/ 'ì˜ì—…ì‹œê°„ ì •ë³´ ì—†ìŒ';
      const lat = place.location?.latitude;
      const lng = place.location?.longitude;

      const div = document.createElement('div');
      const msgAddress = /*[[#{pharmacies.address}]]*/ 'ì£¼ì†Œ';
      const msgPhone = /*[[#{pharmacies.phone}]]*/ 'ì „í™”ë²ˆí˜¸';
      const msgStatus = /*[[#{pharmacies.openStatus}]]*/ 'ìƒíƒœ';
      const msgHours = /*[[#{pharmacies.hours}]]*/ 'ì˜ì—…ì‹œê°„';
      div.classList.add('pharmacy-item', 'mb-3', 'p-3', 'border', 'rounded');
      div.style.cursor = 'pointer';
      div.innerHTML = `
        <h5>${name}</h5>
        <p><strong>${msgAddress}:</strong> ${address}</p>
        <p><strong>${msgPhone}:</strong> ${phone}</p>
        <p><strong>${msgStatus}:</strong> ${openNow}</p>
        <p><strong>${msgHours}:</strong> ${hours}</p>
      `;

      const mapDiv = document.createElement('div');
      mapDiv.style.marginTop = '10px';
      mapDiv.style.display = 'none';

      const mapImg = document.createElement('img');
      mapImg.alt = 'ì•½êµ­ ìœ„ì¹˜';
      mapImg.style.width = '100%';
      mapImg.style.maxHeight = '300px';
      mapImg.style.objectFit = 'cover';
      mapImg.style.cursor = 'pointer';

      const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=16&size=600x300&markers=color:red%7C${lat},${lng}&key=${apiKey}`;
      mapImg.src = mapUrl;

      mapImg.addEventListener('click', () => {
        const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        window.open(url, '_blank');
      });

      mapDiv.appendChild(mapImg);

      div.addEventListener('click', () => {
        selectedLocation = { lat, lng };
        document.querySelectorAll('.pharmacy-item > div').forEach(el => el.style.display = 'none');
        mapDiv.style.display = (mapDiv.style.display === 'none') ? 'block' : 'none';
      });

      pharmacyList.appendChild(div);
      pharmacyList.appendChild(mapDiv);
    });
  }

  function closeDetail() {
    document.getElementById('pharmacyDetail').style.display = 'none';
  }

  function openGoogleMaps() {
    if (selectedLocation) {
      const url = `https://www.google.com/maps/search/?api=1&query=${selectedLocation.lat},${selectedLocation.lng}`;
      window.open(url, '_blank');
    }
  }
</script>
</body>
</html>