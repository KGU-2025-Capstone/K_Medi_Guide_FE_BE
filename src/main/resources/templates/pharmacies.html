<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주변 약국 찾기</title>
  <!-- head 태그 안에 추가 -->
  <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet">
  <link th:href="@{/css/pharmacies.css}" rel="stylesheet">
</head>
<body>
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-8">
      <div class="search-container">
        <h1 class="mb-4">주변 약국 찾기</h1>
        <button class="btn btn-primary" onclick="searchPharmacies()">
          <i class="bi bi-search"></i> 주변 약국 검색
        </button>
      </div>
      <div id="pharmacyList" class="pharmacy-list"></div>
    </div>
    <div id="pharmacyDetail" class="pharmacy-detail">
      <span class="close-btn" onclick="closeDetail()">&times;</span>
      <div class="detail-section">
        <h2 id="detailName" class="mb-4"></h2>
        <p><strong>주소:</strong> <span id="detailAddress"></span></p>
        <p><strong>전화번호:</strong> <span id="detailPhone"></span></p>
      </div>
      <div class="detail-section">
        <p><strong>영업 상태:</strong> <span id="detailOpen"></span></p>
        <p><strong>영업 시간:</strong> <span id="detailHours"></span></p>
      </div>
      <div class="detail-section">
        <h4 class="mb-3">약국 위치</h4>
        <img id="staticMap" class="static-map" onclick="openGoogleMaps()" alt="약국 위치" style="cursor:pointer;">
        <p class="text-muted mt-2">지도를 클릭하면 Google Maps에서 자세한 위치를 확인할 수 있습니다.</p>
        <!-- 구글 지도 열기 버튼 추가 -->
        <button type="button" class="btn btn-outline-primary" onclick="openGoogleMaps()">
          구글 지도에서 보기
        </button>
      </div>
    </div>
  </div>
</div>

<script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
<script th:inline="javascript">
  const apiKey = /*[[${googleMapsApiKey}]]*/ '';
  let selectedAddress = null;

  function searchPharmacies() {
      if (!navigator.geolocation) {
          alert('브라우저가 위치 정보를 지원하지 않습니다.');
          return;
      }

      navigator.geolocation.getCurrentPosition(
          (position) => {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;
              console.log('위치 좌표:', latitude, longitude);

              // Ajax 요청
              fetch(`/api/map/getPharmacy?latitude=${latitude}&longitude=${longitude}`)
                  .then(response => {
                  if (!response.ok) {
                      throw new Error('약국 정보를 불러오는데 실패했습니다.');
                  }
                  return response.json();
              })
                  .then(data => {
                  displayPharmacies(data);
              })
                  .catch(error => {
                  alert(error.message);
              });
          },
          (error) => {
              alert('위치 정보를 가져오는데 실패했습니다: ' + error.message);
          },
          {
              enableHighAccuracy: true, // 🔴 이 옵션이 핵심
              timeout: 10000,           // 10초 안에 응답 없으면 에러
              maximumAge: 0             // 캐시된 위치 허용 안 함
          }
      );
  }

  function displayPharmacies(data) {
    console.log(data)
    const pharmacyList = document.getElementById('pharmacyList');
    pharmacyList.innerHTML = '';

    if (!data.places || data.places.length === 0) {
      pharmacyList.innerHTML = '<p>주변 약국을 찾을 수 없습니다.</p>';
      return;
    }

    data.places.forEach(place => {
      const name = place.displayName?.text || '이름 없음';
      const address = place.formattedAddress || '주소 없음';
      const phone = place.internationalPhoneNumber || '전화번호 없음';
      const openNow = place.currentOpeningHours?.openNow ? '영업중' : '영업 종료';
      const hours = place.currentOpeningHours?.weekdayDescriptions?.join(', ') || '영업시간 정보 없음';
      const lat = place.location?.latitude;
      const lng = place.location?.longitude;

      const div = document.createElement('div');
      div.classList.add('pharmacy-item', 'mb-3', 'p-3', 'border', 'rounded');
      div.style.cursor = 'pointer';
      div.innerHTML = `
      <h5>${name}</h5>
      <p><strong>주소:</strong> ${address}</p>
      <p><strong>전화번호:</strong> ${phone}</p>
      <p><strong>상태:</strong> ${openNow}</p>
      <p><strong>영업시간:</strong> ${hours}</p>
    `;

      // 지도 보여줄 div 생성 (초기에는 숨김)
      const mapDiv = document.createElement('div');
      mapDiv.style.marginTop = '10px';
      mapDiv.style.display = 'none'; // 초기 숨김

      // Static Map 이미지 생성
      const mapImg = document.createElement('img');
      mapImg.alt = '약국 위치';
      mapImg.style.width = '100%';
      mapImg.style.maxHeight = '300px';
      mapImg.style.objectFit = 'cover';
      mapImg.style.cursor = 'pointer';

      // Static Map url 셋팅
      const encodedAddress = encodeURIComponent(address);
      const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${encodedAddress}&zoom=16&size=600x300&markers=color:red%7C${encodedAddress}&key=${apiKey}`;
      mapImg.src = mapUrl;

      // 이미지 클릭 시 구글지도 새창 열기
      mapImg.addEventListener('click', () => {
        const url = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
        window.open(url, '_blank');
      });

      mapDiv.appendChild(mapImg);

      div.addEventListener('click', () => {
        selectedAddress = address;  // 클릭한 약국 주소 저장
        // 기존 토글 지도 보이기/숨기기 코드
        document.querySelectorAll('.pharmacy-item > div').forEach(el => el.style.display = 'none');
        mapDiv.style.display = (mapDiv.style.display === 'none') ? 'block' : 'none';
      });

      pharmacyList.appendChild(div);
      pharmacyList.appendChild(mapDiv);
    });
  }

  function closeDetail() {
    document.getElementById('pharmacyDetail').style.display = 'none';
  }

  function openGoogleMaps() {
    if (selectedAddress) {
      const encodedAddress = encodeURIComponent(selectedAddress);
      const url = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
      window.open(url, '_blank');
    }
  }
</script>
</body>
</html>