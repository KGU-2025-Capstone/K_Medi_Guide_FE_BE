<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주변 약국 찾기</title>
  <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet">
  <link th:href="@{/css/pharmacies.css}" rel="stylesheet">
</head>
<body>
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-8">
      <div class="search-container">
        <h1 class="mb-4">주변 약국 찾기</h1>
        <button class="btn btn-primary" onclick="searchPharmacies()">
          <i class="bi bi-search"></i> 주변 약국 검색
        </button>
      </div>
      <div id="pharmacyList" class="pharmacy-list"></div>
    </div>
    <div id="pharmacyDetail" class="pharmacy-detail">
      <span class="close-btn" onclick="closeDetail()">&times;</span>
      <div class="detail-section">
        <h2 id="detailName" class="mb-4"></h2>
        <p><strong>주소:</strong> <span id="detailAddress"></span></p>
        <p><strong>전화번호:</strong> <span id="detailPhone"></span></p>
      </div>
      <div class="detail-section">
        <p><strong>영업 상태:</strong> <span id="detailOpen"></span></p>
        <p><strong>영업 시간:</strong> <span id="detailHours"></span></p>
      </div>
      <div class="detail-section">
        <h4 class="mb-3">약국 위치</h4>
        <img id="staticMap" class="static-map" onclick="openGoogleMaps()" alt="약국 위치">
        <p class="text-muted mt-2">지도를 클릭하면 Google Maps에서 자세한 위치를 확인할 수 있습니다.</p>
      </div>
    </div>
  </div>
</div>

<script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
<script th:inline="javascript">
  const apiKey = /*[[${googleMapsApiKey}]]*/ '';
  let selectedPharmacy = null;

  function searchPharmacies() {
      const latitude = 37.5;  // 예시 좌표 (서울 강남구)
      const longitude = 127.0;

      fetch(`/pharmacies/nearby?latitude=${latitude}&longitude=${longitude}`)
          .then(response => response.json())
          .then(pharmacies => {
              const pharmacyList = document.getElementById('pharmacyList');
              pharmacyList.innerHTML = '';

              pharmacies.forEach(pharmacy => {
                  const div = document.createElement('div');
                  div.className = 'pharmacy-item';
                  div.innerHTML = `
                      <h3>${pharmacy.name}</h3>
                      <p>${pharmacy.address}</p>
                      <span class="status-badge ${pharmacy.isOpen ? 'status-open' : 'status-closed'}">
                          ${pharmacy.isOpen ? '영업 중' : '영업 종료'}
                      </span>
                  `;
                  div.onclick = () => showPharmacyDetail(pharmacy);
                  pharmacyList.appendChild(div);
              });
          })
          .catch(error => {
              console.error('Error:', error);
              alert('약국 정보를 가져오는데 실패했습니다.');
          });
  }

  function showPharmacyDetail(pharmacy) {
      const previousSelected = document.querySelector('.pharmacy-item.selected');
      if (previousSelected) {
          previousSelected.classList.remove('selected');
      }

      const currentItem = event.currentTarget;

      if (selectedPharmacy && selectedPharmacy.id === pharmacy.id) {
          closeDetail();
          selectedPharmacy = null;
          return;
      }

      selectedPharmacy = pharmacy;
      currentItem.classList.add('selected');

      document.getElementById('detailName').textContent = pharmacy.name;
      document.getElementById('detailAddress').textContent = pharmacy.address;
      document.getElementById('detailPhone').textContent = pharmacy.phoneNumber || '정보 없음';

      const openStatus = document.getElementById('detailOpen');
      openStatus.innerHTML = `<span class="status-badge ${pharmacy.isOpen ? 'status-open' : 'status-closed'}">${pharmacy.isOpen ? '영업 중' : '영업 종료'}</span>`;

      document.getElementById('detailHours').textContent = pharmacy.openingHours || '정보 없음';

      const staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${pharmacy.latitude},${pharmacy.longitude}&zoom=15&size=400x200&markers=color:red%7C${pharmacy.latitude},${pharmacy.longitude}&key=${apiKey}`;
      document.getElementById('staticMap').src = staticMapUrl;

      document.getElementById('pharmacyDetail').classList.add('active');
  }

  function closeDetail() {
      document.getElementById('pharmacyDetail').classList.remove('active');
      const selectedItem = document.querySelector('.pharmacy-item.selected');
      if (selectedItem) {
          selectedItem.classList.remove('selected');
      }
      selectedPharmacy = null;
  }

  function openGoogleMaps() {
      if (selectedPharmacy) {
          window.open(`https://www.google.com/maps/search/?api=1&query=${selectedPharmacy.latitude},${selectedPharmacy.longitude}`);
      }
  }
</script>
</body>
</html>